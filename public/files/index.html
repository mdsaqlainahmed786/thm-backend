<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .userlist {
            display: flex;
            gap: 0.5rem;
            background-color: #f2f2f2;
        }

        .user-avatar {
            width: 64.8px;
            height: 64.8px;
            border-radius: 50%;
            position: relative;
            border: 1px solid white;
            padding: 0px;
        }

        .user-avatar img {
            width: 64.8px;
            height: 64.8px;
            object-fit: fill;
            border-radius: 50%;
        }

        .online {
            width: 12px;
            height: 12px;
            background-color: #5FD900;
            position: absolute;
            border-radius: 50%;
        }

        .font-14 {
            font-size: 14px;
        }

        .font-12 {
            font-size: 12px
        }

        .message {
            border-radius: 12px;
            padding: 10px;
            background-color: #f2f9f9;
            color: #000;

        }

        .message.left {
            margin-right: 55%;
        }

        .message.right {
            background-color: rgb(118, 0, 57);
            color: rgb(224, 221, 217);
            margin-left: 50%;
        }

        #chatbox {
            overflow-x: hidden;
            height: 600px;
            overflow-y: scroll;
            border: 1px solid #f3f3f3;
            padding: 1rem 0.5rem;
        }

        #last-seen {
            font-size: 13px;
        }

        .font-10 {
            font-size: 10px;
        }

        #targetUsername {
            margin-bottom: 0.25rem;
        }

        .unseen-message {
            position: absolute;
            right: 0px;
            top: 7px;
            background: black;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Chat container -->

    <div class="d-flex justify-content-center row">
        <div class="col-md-8 mt-5">
            <div class="d-flex gap-3 mb-3">
                <div class="btn btn-sm btn-light userlist-button">11AQGCD9X369LFWY</div>
                <div class="btn btn-sm btn-light userlist-button">amitkesle18</div>
                <div class="btn btn-sm btn-light userlist-button">demo89</div>
                <div class="btn btn-sm btn-light userlist-button">kiranappcrunk25</div>
            </div>
            <form id="loginForm">
                <div class="d-flex flex-column justify-content-center align-items-center gap-3">
                    <input type="text" id="username" class="form-control form-control-sm" style="max-width: 400px;"
                        placeholder="Enter your username" />
                    <button type="submit" class="btn btn-sm btn-success">Login</button>
                </div>
            </form>
        </div>
        <div class="col-md-8">
            <div class="justify-content-end d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center pt-2 pb-2">
                    <div id="loginAs" class="" style="width: 200px;">
                    </div>
                    <input type="text" value="" id="search" class="form-control form-control-sm" />
                </div>
                <div id="userlistAndChatHistory">
                    <div id="userList" class="userlist">
                    </div>
                    <div class="list-item d-flex flex-column mt-3" id="chatHistory">
                    </div>
                </div>
                <div class="d-flex" id="userIsTyping"></div>
            </div>
            <div id="chatContainer">
                <div class="d-flex gap-2 align-items-center">
                    <button id="backTo" class="btn btn-sm btn-light">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <img src="" id="targetUserProfile" class="user-avatar" />
                    <div>
                        <h5 id="targetUsername"></h5>
                        <p class="mb-0" id="last-seen"></p>
                    </div>
                </div>
                <div id="chatbox" class="d-flex flex-column gap-2">
                </div>
                <form id="messageForm" class="d-flex gap-2 justify-content-end mt-3">
                    <button type="button" class="btn" id="leaveChat">
                        <i class="fa fa-times"></i>
                    </button>
                    <select id="sendGift" class="form-select form-select-sm">
                        <option value="">select sticker</option>
                        <option value="2NYTWDXC">sticker 2NYTWDXC</option>
                        <option value="KVU189H7">sticker KVU189H7</option>
                        <option value="DV8K99Z8">sticker DV8K99Z8</option>
                        <option value="KKGD9G3X">sticker KKGD9G3X</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-light" id="sendImage">
                        <i class="fa fa-image"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light" id="sendVideo">
                        <i class="fa fa-video-camera"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light " id="sendLocation">
                        <i class="fa fa-map-marker"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light " id="sendLink">
                        <i class="fa fa-link"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light" id="sendContact">
                        <i class="fa fa-phone"></i>
                    </button>
                    <input type="hidden" id="senderID" />
                    <input type="text" id="message" class="form-control form-control-sm" />
                    <button type="submit" class="btn btn-sm btn-light">
                        <i class="fa fa-telegram"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="module">
        import { Manager, io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js";
        const URL = window.location.origin;
        export const socket = io(URL, { autoConnect: false });
        const RandomProfiles = [`https://randomuser.me/api/portraits/women/30.jpg`, `https://randomuser.me/api/portraits/men/95.jpg`, `https://randomuser.me/api/portraits/men/91.jpg`, `https://randomuser.me/api/portraits/men/90.jpg`];

        localStorage.setItem("currentPage", 1);
        $("#chatContainer").hide();
        $("#loginForm").on("submit", function (e) {
            e.preventDefault();
            const username = $("#username").val();
            const randomIndex = Math.floor(Math.random() * RandomProfiles.length);
            const image = RandomProfiles[randomIndex]
            socket.auth = { username };
            socket.connect();
            $("#loginAs").text(`Login As::    ${username}`);
            $("#loginForm").hide();
            socket.emit("chat screen");
            socket.emit("users");
        });
        socket.on("connect", () => {
            console.log("User connected");
            socket.emit("users");
        });
        socket.on("disconnect", () => {
            console.log("User disconnected");
            socket.emit("users");
        });

        //******
        socket.on("session", (data) => {
            console.log("session", data);
        })
        //****Done
        socket.on("users", (data) => {
            console.log("users", data);
            $("#userList").html(``);
            data.map((user) => {
                $("#userList").append(`<div class="d-flex flex-column gap-1 chat-items"  data-id="${user.username}" data-image="${user?.profilePic?.small}">
                        <div class="user-avatar" title="${user.username}">
                       ${user.isOnline ? `<div class="online"></div>` : ''} 
                        <img src="${user?.profilePic?.small}"/>
                        </div>
                        <small>${user.name}</small>
                    </div>
                    `)
            });
        });

        socket.on("chat screen", function (chatHistory) {
            console.log(chatHistory, "chat screen");
            $("#chatHistory").html(``);
            chatHistory.messages.map((data) => {
                let messages = ``;
                messages += `<div class="d-flex align-items-center gap-3 chat-items mb-3" data-id="${data.username}" data-image="${data.profilePic.small}">
                    <div class="user-avatar">
                        <img src="${data.profilePic.small}" class=""/>
                    </div>
                    <div class="d-flex flex-column position-relative">
                        ${data.unseenCount !== 0 ? ` 
                            <div class="unseen-message">
                           ${data.unseenCount}
                           </div>
                        `: ''}
                        <div class="font-14">${data.username}</div>
                        <div><h6 class="${data.isSeen ? 'text-muted' : 'text-black'}">${data.message}</h6></div>
                        <div class="font-12">${data.createdAt}</div>
                    </div>
                </div>`;
                $("#chatHistory").append(messages)
            });
        });
        $(document).on("click", "#backTo", function () {
            $("#chatContainer").hide();
            $("#userlistAndChatHistory").show();
        });
        $(document).on("focus", "#message", () => {
            socket.emit("typing");
        })
        $(document).on("blur", "#message", () => {
            socket.emit("stop typing");
        })
        socket.on("typing", (data) => {
            $("#userIsTyping").text(`${data.username} is typing ....`)
        });
        socket.on("stop typing", (data) => {
            $("#userIsTyping").text(``)
        })
        $("#messageForm").on("submit", function (e) {
            e.preventDefault();
            const message = $("#message").val();
            console.log(message);
            const senderID = $("#senderID").val();
            if (!message) {
                alert("message is required");
                return false
            }
            socket.emit("private message", {
                message: {
                    type: "text",
                    message: message
                },
                to: senderID
            });
            $("#chatbox").append(`
                    <div class="message right">
                        <div>
                            ${message}
                        </div>
                    </div>
                `);
            $("#message").val("");
            socket.emit("chat screen");
        });
        socket.on("private message", ({ message, from, to }) => {
            console.log("private message", { message, from, to });
            setTimeout(() => {
                socket.emit("chat screen");
            }, 500);
        });
        socket.on("message seen", function () {
            console.log("seen message from user");
            const senderID = $("#senderID").val();
            let pageNumber = localStorage.getItem('currentPage');
            socket.emit("fetch conversations", { username: senderID, pageNumber });
        });

        socket.on("user connected", (user) => {
            console.log("User Connected", user);
            socket.emit("users");
        });
        socket.on("user disconnected", (user) => {
            console.log("User Disconnected", user);
            socket.emit("users");
        });
        socket.on("connect_error", (err) => {
            console.log(err)
        });

        $("#chatbox").on('scroll', function (e) {
            if ($('#chatbox').scrollTop() < 1) {
                let pageNumber = localStorage.getItem('currentPage');
                if (pageNumber) {
                    pageNumber = parseInt(pageNumber) + 1;
                }
                localStorage.setItem('currentPage', pageNumber);
                const senderID = $("#senderID").val();
                socket.emit("fetch conversations", { username: senderID, pageNumber });
            }
        });


        $(document).on("click", ".chat-items", function () {
            const senderID = $(this).data("id");
            const image = $(this).data("image");
            $("#senderID").val(senderID);
            $("#chatContainer").show();
            $("#targetUserProfile").attr("src", image);
            $("#targetUsername").text(senderID);
            $("#userlistAndChatHistory").hide();
            const currentPage = localStorage.getItem('currentPage')
            socket.emit("fetch conversations", { username: senderID, pageNumber: currentPage });
            socket.emit("fetch last seen", senderID);
            socket.emit("message seen", senderID);
            socket.emit("in chat", senderID);
            scrollToBottom();
        });
        /***Done **/
        socket.on("fetch conversations", function (data) {
            console.log("fetch conversations", data)
            const messages = data.messages;
            if (data.pageNo === 1) {
                $("#chatbox").html(``);
                messages.map((message) => {
                    switch (message.type) {
                        case "text":
                            $("#chatbox").append(`
                        <div class="message ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex justify-content-between">
                                <h6>${message.message}</h6>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "contact":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-phone"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small>${message.contact}</small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "link":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-link"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small><a href="${message.link}" target="_blank">${message.link}</a></small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "image":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex flex-column">
                                <image src="${message.mediaUrl}" />
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "video":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                        <div class="d-flex flex-column">
                            <video  height="240" controls>
                                <source src="${message.mediaUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                        </div>
                        </div>
                    `);
                            break;
                        case "gift":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                        <div class="d-flex flex-column">
                                <image src="${message.gift}" />
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "location":
                            $("#chatbox").append(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-map-marker"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.location.placeName}</h6>
                                    <small>${message.location.lat} ${message.location.lng}</small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                               
                            </div>
                        </div>
                     `);
                            break;
                    }

                });
                scrollToBottom();
            } else {
                messages.map((message) => {
                    console.log(message);
                    switch (message.type) {
                        case "text":
                            $("#chatbox").prepend(`
                        <div class="message ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex">
                                <h6>${message.message}</h6>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "contact":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-phone"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small>${message.contact}</small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "link":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-link"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small><a href="${message.link}" target="_blank">${message.link}</a></small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "image":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex flex-column">
                                <image src="${message.mediaUrl}" />
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "video":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                        <div class="d-flex flex-column">
                            <video  height="240" controls>
                                <source src="${message.mediaUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                        </div>
                        </div>
                    `);
                            break;
                        case "gift":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                        <div class="d-flex flex-column">
                                <image src="${message.gift}" />
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                            </div>
                        </div>
                    `);
                            break;
                        case "location":
                            $("#chatbox").prepend(`
                        <div class="message  ${message.sentByMe ? 'right' : 'left'} ">
                            <div class="d-flex gap-2">
                                <i class="fa fa-map-marker"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.location.placeName}</h6>
                                    <small>${message.location.lat} ${message.location.lng}</small>
                                </div>
                                ${message.isSeen ? `<div class="d-flex align-items-end">
                                    <i class="fa fa-check-circle"></i>
                                </div>`: ''}
                               
                            </div>
                        </div>
                     `);
                            break;
                    }
                });
            }

        });
        /***Done **/
        socket.on("last seen", function (message) {
            $("#last-seen").text(message);
        });

        $(document).on("click", "#sendContact", function () {
            const senderID = $("#senderID").val();
            const message = {
                type: "contact",
                message: 'Mr Bean',
                contact: '+18653528955'
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                            <div class="d-flex gap-2">
                                <i class="fa fa-phone"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small>${message.contact}</small>
                                </div>
                            </div>
                        </div>
            `);
            scrollToBottom();
        });
        $(document).on("click", "#sendLocation", function () {
            const senderID = $("#senderID").val();
            const message = {
                type: "location",
                message: 'Location',
                location: {
                    lat: 20.5937,
                    lng: 78.9629,
                    placeName: 'India',
                }
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                            <div class="d-flex gap-2">
                                <i class="fa fa-map-marker"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.location.placeName}</h6>
                                    <small>${message.location.lat} ${message.location.lng}</small>
                                </div>
                            </div>
                        </div>
            `);
            scrollToBottom();
        });
        $(document).on("click", "#sendLink", function () {
            const senderID = $("#senderID").val();
            const message = {
                type: "link",
                message: 'W3C',
                link: 'https://www.w3.org/'
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                            <div class="d-flex gap-2">
                                <i class="fa fa-link"></i>
                                <div class="d-flex flex-column">
                                    <h6>${message.message}</h6>
                                    <small><a href="${message.link}" target="_blank">${message.link}</a></small>
                                </div>
                            </div>
                        </div>
                    `);
            scrollToBottom();
        });
        $(document).on("click", "#sendImage", function () {
            const senderID = $("#senderID").val();
            const message = {
                type: "image",
                message: '',
                mediaUrl: 'https://images.pexels.com/photos/1319908/pexels-photo-1319908.jpeg?auto=compress&cs=tinysrgb&w=600'
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                        <div class="d-flex flex-column">
                                <image src="${message.mediaUrl}" />
                            </div>
                        </div>
                    `);
            scrollToBottom();
        })
        $(document).on("click", "#sendVideo", function () {
            const senderID = $("#senderID").val();
            const message = {
                type: "video",
                message: 'W3C',
                mediaUrl: 'https://vod-progressive.akamaized.net/exp=1710766502~acl=%2Fvimeo-prod-skyfire-std-us%2F01%2F2605%2F21%2F538027401%2F2549279597.mp4~hmac=b7611b935936cc13312dc924ab113a24dd54bfdec77f5012214948a9b63232ca/vimeo-prod-skyfire-std-us/01/2605/21/538027401/2549279597.mp4?filename=file.mp4'
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                        <div class="d-flex flex-column">
                            <video  height="240" controls>
                                <source src="${message.mediaUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            </div>
                        </div>
                    `);
            scrollToBottom();
        });
        $(document).on("change", "#sendGift", function () {
            const senderID = $("#senderID").val();
            const value = $(this).val();

            const message = {
                type: "gift",
                message: '',
                gift: value
            }
            socket.emit("private message", {
                message: message,
                to: senderID
            });
            $("#chatbox").append(`
                        <div class="message right">
                        <div class="d-flex flex-column">
                            ${message.gift}
                            </div>
                        </div>
                    `);
            scrollToBottom();
        });
        $(document).on("keyup", "#search", function (e) {
            const pageNo = 1;
            const query = e.target.value;
            console.log(query);
            socket.emit("chat screen", { query, pageNo });
        });
        $(document).on("click", "#leaveChat", function () {
            const senderID = $("#senderID").val();
            socket.emit("leave chat", senderID)
        })
        $(document).on("click", ".userlist-button", function () {
            $("#username").val($(this).text())
        });
        const scrollToBottom = () => {
            const element = document.getElementById("chatbox");
            element.scrollTop = element.scrollHeight;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>